// poseidon2.circom
pragma circom 2.1.5;

/*
 * Poseidon2 置换模板
 * t: 状态宽度 (state width)
 * R_F: 全轮数 (number of full rounds)
 * R_P: 部分轮数 (number of partial rounds)
 */
template Poseidon2Permutation(t, R_F, R_P) {
    // 检查参数
    assert(t == 3);
    assert(R_F == 8);
    assert(R_P == 56);
    var d = 5;

    // 输入和输出
    signal input in[t];
    signal output out[t];

    // 状态寄存器
    signal state[t];

    // 从经过验证的来源获取的圆常数
    // 这些是针对 t=3, F_p (Baby Jubjub) 的
    var C[R_F + R_P][t] = [
        ["13079495811802137605", "8600012739378129623", "12896894080798132660"],
        ["691456578033081055", "16260196237841367058", "10280456488310341617"],
        ["15291771485304602271", "17255146193836104765", "14826139866164585510"],
        ["2848243455928221695", "16246321287140801697", "14214479361730063590"],
        ["9665671158434687041", "6138677469149486933", "14104085449079983428"],
        ["5632283088327140161", "3498144686414963324", "7649539252069777532"],
        ["7820461878848792033", "4726584288820875062", "7963390098595011382"],
        ["4706599723659431499", "5722339891000673323", "7600869389531190246"],
        ["6598919692484501379", "3337922245230952891", "2251341144883995579"],
        ["4010620023475960819", "7008630308064618312", "2408990117070185010"],
        ["10570075677918356503", "16654203118949318991", "16629162973516598821"],
        ["9411984251641029281", "11985169601431602046", "5480574898146740019"],
        ["4378932450849924104", "3374838618491765179", "7978749437171561286"],
        ["2392723326176985979", "6268802905471442563", "11736637375626213025"],
        ["8151878779435193096", "17515152331578332841", "17061736417726539058"],
        ["10878598460627581573", "16990431358392110684", "4916896131494488972"],
        ["7784013401569429400", "2789127715077271960", "7048123067755776097"],
        ["11270273898028758811", "5977997970868777732", "11403061746244799077"],
        ["15082405615360983271", "18091807662589087301", "16829746358450411685"],
        ["17342080034637683100", "8828983633658607102", "16616335160867160756"],
        ["7323861273570624776", "6879895066601486449", "5849887018872580869"],
        ["9218684742490515647", "11664124376518118029", "8711494633857597560"],
        ["992336348633918544", "17498418043640003063", "18386345638531093153"],
        ["17849183313936932788", "16332115858632610738", "10271607062534571999"],
        ["11042738228387084473", "7369363323062078693", "11728638318181650893"],
        ["9976311029496660161", "11388383836376722238", "6703562215984364197"],
        ["12444583151880479093", "18442387532363991285", "18318685834825927541"],
        ["11599813133887037701", "7820128038743128456", "13143360295193988523"],
        ["10134423377771891964", "13143314488340156417", "10058774786191753173"],
        ["10034338965038198759", "10939316664964171205", "11400874559409890184"],
        ["14619934441584288424", "11718107936665780287", "18300220364111306935"],
        ["14466993883373449364", "18266221203102434316", "13148135111942416976"],
        ["10730104394056236248", "6074223253406263575", "11855688536254050481"],
        ["10014294970878586221", "4410292790901768853", "12197609228471168697"],
        ["14707124915606992521", "11524354226305335934", "13809623865243452485"],
        ["2006730335198031227", "12901303328564275000", "11984288081232824200"],
        ["1500331822833355345", "14235833486303862256", "7019799480838392100"],
        ["11634629481640246234", "12686734005697274095", "11408800171954388632"],
        ["11135436159654165539", "13063852899454652419", "7488352697843477810"],
        ["2403632947113110536", "11822557343588384958", "14757519163535905221"],
        ["9145618585489959627", "13083311631484215205", "15918716301633512312"],
        ["11566839352119931555", "11613143398935406451", "13768019329141047715"],
        ["14713833446049449220", "3827581504953932280", "6434412953218584851"],
        ["11124436531985338021", "14490899071507923769", "1244436853248880658"],
        ["18434866613309324021", "13637824859063231362", "4410313568759553592"],
        ["1073145463283258525", "11828236113423719833", "7953267591942055745"],
        ["2984958381835777891", "2408375681653846620", "3046754541300973270"],
        ["15024340244677761159", "17764005872132338276", "4386737153406282869"],
        ["17377194247551095941", "17109279584742469902", "13759974526369062330"],
        ["1741697098482645183", "3051433365922718115", "10191242337774708740"],
        ["3430581454746682014", "11283625439502941372", "6657999868832049976"],
        ["11561706696409419139", "1468944565011736637", "6312489830303683074"],
        ["4469733230937617305", "13258880854275150821", "17942702598381014561"],
        ["7130845341427183325", "6884021487819194520", "6140510006795408540"],
        ["2164470980424771973", "14757870933223594152", "291040409058864757"],
        ["13781290533682855112", "14479979361738150616", "2333790518884964727"],
        ["2915003180880753080", "5512278453338575794", "4301569997195744951"],
        ["18042188248386415175", "13106591322495671569", "5884972382903803921"],
        ["14408460677271446487", "11961456191491753696", "4352125134309339327"],
        ["4533036283547849318", "12520633859039339243", "1547926189905953049"],
        ["15416209520845118552", "1118804922378891542", "2088899884570183317"],
        ["12444155168233215804", "14249110444322967980", "9532657388339796030"],
        ["2715085387431114582", "4569488698188152003", "12140401738760920404"]
    ];
    
    // MDS 矩阵 M (对于 t=3, M_E 和 M_I 是相同的)
    var M[t][t] = [[2, 1, 1], [1, 2, 1], [1, 1, 3]];

    // 矩阵乘法辅助函数
    template MatrixMul() {
        signal input in[t];
        signal output out[t];
        var tmp[t];
        for (var i = 0; i < t; i++) {
            tmp[i] = 0;
            for (var j = 0; j < t; j++) {
                tmp[i] += M[i][j] * in[j];
            }
        }
        for (var i = 0; i < t; i++) {
            out[i] <== tmp[i];
        }
    }

    // 初始状态
    for (var i = 0; i < t; i++) {
        state[i] <== in[i];
    }

    var round = 0;

    // 1. 初始外部轮 (R_F / 2)
    for (var i = 0; i < R_F / 2; i++) {
        // AddRoundConstant
        for (var j = 0; j < t; j++) state[j] <== state[j] + C[round][j];
        // S-Box (Full)
        for (var j = 0; j < t; j++) state[j] <== state[j] ** d;
        // Linear Layer
        component mat_mul_ext1 = MatrixMul();
        for (var j = 0; j < t; j++) mat_mul_ext1.in[j] <== state[j];
        for (var j = 0; j < t; j++) state[j] <== mat_mul_ext1.out[j];
        round++;
    }

    // 2. 内部轮 (R_P)
    for (var i = 0; i < R_P; i++) {
        // AddRoundConstant
        for (var j = 0; j < t; j++) state[j] <== state[j] + C[round][j];
        // S-Box (Partial on state[0])
        state[0] <== state[0] ** d;
        // Linear Layer
        component mat_mul_int = MatrixMul();
        for (var j = 0; j < t; j++) mat_mul_int.in[j] <== state[j];
        for (var j = 0; j < t; j++) state[j] <== mat_mul_int.out[j];
        round++;
    }

    // 3. 最终外部轮 (R_F / 2)
    for (var i = 0; i < R_F / 2; i++) {
        // AddRoundConstant
        for (var j = 0; j < t; j++) state[j] <== state[j] + C[round][j];
        // S-Box (Full)
        for (var j = 0; j < t; j++) state[j] <== state[j] ** d;
        // Linear Layer
        component mat_mul_ext2 = MatrixMul();
        for (var j = 0; j < t; j++) mat_mul_ext2.in[j] <== state[j];
        for (var j = 0; j < t; j++) state[j] <== mat_mul_ext2.out[j];
        round++;
    }
    
    // 输出最终状态
    for (var i = 0; i < t; i++) {
        out[i] <== state[i];
    }
}


/*
 * 主哈希模板
 * - 公开输入: hash
 * - 隐私输入: preimage
 */
template Poseidon2Hasher() {
    // 隐私输入 (哈希原象)
    signal private input preimage;
    // 公开输入 (哈希结果)
    signal public output hash;

    // 参数
    var t = 3;
    var R_F = 8;
    var R_P = 56;

    // 实例化 Poseidon2 置换
    component p = Poseidon2Permutation(t, R_F, R_P);

    // 设置初始状态。根据惯例，对于单个输入的哈希，
    // 我们将输入放在 state[1]，其余位置为0。
    // state = [capacity, rate, capacity]
    p.in[0] <== 0;
    p.in[1] <== preimage;
    p.in[2] <== 0;
    
    // 哈希结果是置换输出的第一个元素
    hash <== p.out[0];
}

// 实例化主组件
component main {public [hash]} = Poseidon2Hasher();